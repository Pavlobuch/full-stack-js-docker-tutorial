name: Deploy (OIDC -> AWS SSM -> Private EC2)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Resolve App InstanceId by tag Name
        id: find_app
        env:
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
          REPO_URL: ${{ secrets.REPO_URL }}
        run: |
          set -euo pipefail

          echo "DEBUG: PROJECT_NAME='${PROJECT_NAME}'"
          if [ -z "${PROJECT_NAME}" ]; then
            echo "ERROR: PROJECT_NAME is empty. Create repo variable PROJECT_NAME (Settings -> Actions -> Variables)."
            exit 1
          fi

          INSTANCE_ID="$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${PROJECT_NAME}-app" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)"

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "None" ]; then
            echo "ERROR: Could not find running instance with tag Name=${PROJECT_NAME}-app"
            echo "INFO: Listing running Name tags for debugging:"
            aws ec2 describe-instances \
              --filters "Name=instance-state-name,Values=running" \
              --query "Reservations[].Instances[].Tags[?Key=='Name'].Value" \
              --output text
            exit 1
          fi

          echo "instance_id=$INSTANCE_ID" >> "$GITHUB_OUTPUT"
          echo "App InstanceId: $INSTANCE_ID"


      - name: Deploy via SSM (git reset + docker compose up)
        env:
          REPO_URL: ${{ secrets.REPO_URL }}
        run: |
          set -euo pipefail
          IID="${{ steps.find_app.outputs.instance_id }}"

          CMD_ID="$(aws ssm send-command \
            --instance-ids "$IID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy fullstack" \
            --parameters 'commands=[
              "set -euo pipefail",
              "whoami",
              "pwd",
              "export HOME=/root",
              "REPO_URL=\"'"${REPO_URL}"'\"",
              "APP_ROOT=/opt/apps",
              "APP_DIR=/opt/apps/fullstack",

              "mkdir -p \"$APP_ROOT\"",

              "if [ ! -d \"$APP_DIR/.git\" ]; then echo \"Repo missing -> cloning\"; rm -rf \"$APP_DIR\"; git clone \"$REPO_URL\" \"$APP_DIR\"; fi",

              "git config --global --add safe.directory \"$APP_DIR\"",
              "cd \"$APP_DIR\"",
              "git fetch --prune origin",
              "git reset --hard origin/main",

              "cd \"$APP_DIR/finished\"",
              "docker compose up -d --build",
              "docker compose ps"
            ]' /

            --query "Command.CommandId" --output text)"

          echo "SSM CommandId: $CMD_ID"

          # Wait WITHOUT failing the step immediately
          set +e
          aws ssm wait command-executed --command-id "$CMD_ID" --instance-id "$IID"
          WAIT_RC=$?
          set -e

          STATUS="$(aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "$IID" --query "Status" --output text)"
          echo "SSM Status: $STATUS"

          echo "----- STDOUT -----"
          aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "$IID" --query "StandardOutputContent" --output text || true

          echo "----- STDERR -----"
          aws ssm get-command-invocation --command-id "$CMD_ID" --instance-id "$IID" --query "StandardErrorContent" --output text || true

          # fail the step if SSM failed
          if [ "$WAIT_RC" -ne 0 ] || [ "$STATUS" != "Success" ]; then
            echo "ERROR: SSM command failed"
            exit 1
          fi


      - name: Health-check via ALB
        env:
          ALB_URL: ${{ secrets.ALB_URL }}
        run: |
          set -euo pipefail
          curl -fsS -I "$ALB_URL" | head -n 1
